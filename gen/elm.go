package main

import (
  "strings"
  "fmt"
  "os"
)

type Class struct {
  Name string
  CConstructFunc string
  GoConstructFunc BridgeFunc
}

func genElmClasses(funcs []CFunc) {
  // find all constructors
  classes := make([]Class, 0)
  for _, fun := range funcs {
    if strings.HasPrefix(fun.Name, "elm_") && strings.HasSuffix(fun.Name, "_add") && fun.ReturnType == "Evas_Object *" {
      if _, has := DISCARD_CONSTRUCT_FUNCS[fun.Name]; has { continue }
      className := convertToClassName(fun.Name)
      class := Class{
        Name: className,
        CConstructFunc: fun.Name,
        GoConstructFunc: makeGoConstructFunc(className, fun),
      }
      classes = append(classes, class)
    }
  }

  genClasses(classes)
}

func convertToClassName(name string) string {
  name = name[len("elm_") : len(name) - len("_add")]
  seg := strings.Split(name, "_")
  for i, s := range seg {
    seg[i] = strings.Title(s)
  }
  name = strings.Join(seg, "")
  return name
}

func makeGoConstructFunc(className string, fun CFunc) BridgeFunc {
  gofunc := BridgeFunc{
    ParamNames: make([]string, 0),
    ParamTypes: make([]string, 0),
    HelperCodes: make([]string, 0),
  }
  gofunc.Name = "New" + className
  for i, name := range fun.ParamNames {
    gofunc.ConvertParam(name, fun.ParamTypes[i])
  }
  gofunc.ReturnTypes = []string{"*" + className}
  gofunc.CgoFunc = fun.Name
  gofunc.ReturnExpression = "&" + className + "{obj: _cgo_return_}"
  return gofunc
}

func genClasses(classes []Class) {
  outputFile, err := os.Create("../elm.go")
  if err != nil { panic(err) }
  defer outputFile.Close()
  outputFile.Write([]byte(`package elm // generated by elm.go

//#include <Elementary.h>
import "C"
import (
  "unsafe"
)

type EvasObject interface {
  GetObj() *C.Evas_Object
}
`))
  for _, class := range classes {
    fmt.Fprintf(outputFile, `
type %s struct { obj *C.Evas_Object }
func (self *%s) GetObj() *C.Evas_Object { return self.obj }
`, class.Name, class.Name)
    outputFile.Write([]byte("\n"))
    outputFile.Write([]byte(class.GoConstructFunc.Gen()))
  }
}
